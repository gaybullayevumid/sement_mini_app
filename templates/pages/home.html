{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Telegram user_id ni olish uchun script -->
<script>
  window.USER_ID = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe &&
    window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.id)
    ? window.Telegram.WebApp.initDataUnsafe.user.id
    : 'test_user';
</script>

<div class="container">
    <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê</button>
    <div class="header">
        <h1>üèóÔ∏è Sement Market</h1>
        <p>Qurilish materiallari onlayn</p>
    </div>

    <!-- Role Selector -->
    <div id="roleSelector" class="role-selector">
        <h2>Rolni tanlang:</h2>
        <div class="role-cards">
            <div class="role-card" onclick="selectRole('client')">
                <span class="role-icon">üë§</span>
                <h3>Mijoz</h3>
                <p>Mahsulot xarid qilish</p>
            </div>
            <div class="role-card" onclick="selectRole('seller')">
                <span class="role-icon">üè™</span>
                <h3>Sotuvchi</h3>
                <p>Mahsulot sotish</p>
            </div>
        </div>
    </div>

    <!-- Client Interface -->
    <div id="clientInterface" class="main-content">
        <div class="section">
            <h2>üõçÔ∏è Mahsulotlar</h2>
            <div id="productList" class="product-grid">
                {% for product in products %}
                <div class="product-item">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="Rasm" style="width:100%;max-width:180px;border-radius:8px;margin-bottom:10px;" />
                    {% endif %}
                    <h4>{{ product.name }}</h4>
                    <p><b>Brend:</b> {{ product.brand }}</p>
                    <p><b>Turi:</b> {{ product.type }}</p>
                    <p><b>Sifat:</b> {{ product.quality }}</p>
                    <p><b>Og'irligi:</b> {{ product.weight }} t</p>
                    <p><b>Klass:</b> {{ product.cement_class }}</p>
                    <p><b>Kelib chiqishi:</b> {{ product.origin }}</p>
                    <p>{{ product.description }}</p>
                    <div class="product-price">{{ product.price }} so'm/tonna</div>
                    <button class="btn" onclick="addToCart({{ product.id }})" {% if product.weight == 0 %}disabled{% endif %}>
                        {% if product.weight == 0 %}Tugagan{% else %}Savatga qo'shish{% endif %}
                    </button>
                </div>
                {% empty %}
                <p class="loading">Mahsulotlar yuklanmoqda</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Seller Interface -->
    <div id="sellerInterface" class="main-content">
        <div class="section">
            <h2>üìã Buyurtmalar</h2>
            <div id="ordersList">
                {% for order in orders %}
                <div class="order-item">
                    <h4>Buyurtma #{{ order.id }}</h4>
                    <p><b>Vaqti:</b> {{ order.date|date:"Y-m-d H:i" }}</p>
                    <p><b>Buyurtmachi:</b> {{ order.client }}</p>
                    <p><b>Jami:</b> {{ order.total_price }} so'm</p>
                    <p><b>Status:</b>
                        <span class="order-status status-{{ order.status }}">{{ order.status }}</span>
                    </p>
                    <div>
                        <b>Mahsulot:</b>
                        <div>
                            {{ order.product.name }} x {{ order.quantity }} t
                        </div>
                    </div>
                </div>
                {% empty %}
                    <p style="text-align: center; color: #7f8c8d;">Buyurtmalar yo‚Äòq</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Floating Cart Button -->
    <div class="floating-cart" id="floatingCart" onclick="showCart()">
        üõí
        <span class="cart-badge" id="cartBadge">0</span>
    </div>
</div>

<!-- Cart Modal -->
<div id="cartModal" class="modal">
    <div class="modal-content">
        <h2>üõí Savat</h2>
        <div id="cartItems"></div>
        <div style="border-top: 2px solid #ecf0f1; margin-top: 20px; padding-top: 20px;">
            <h3>Jami: <span id="totalPrice">0</span> so'm</h3>
            <button class="btn btn-success" onclick="checkout()">Buyurtma berish</button>
            <button class="btn" onclick="closeCart()">Yopish</button>
        </div>
    </div>
</div>

<!-- Sement cart JS (static/sement_cart.js) -->
<script src="{% static 'sement_cart.js' %}"></script>
{% endblock content %}